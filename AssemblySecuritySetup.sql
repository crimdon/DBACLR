/**********************************************
 * Script:  AssemblySecuritySetup.sql
 * Date:    2016-01-20
 * By:      Solomon Rutzky
 * Of:      Sql Quantum Leap ( http://SqlQuantumLeap.com )
 * 
 * Stairway to SQLCLR - Level 6: Development Tools
 *
 * Stairway to SQLCLR series:
 * http://www.sqlservercentral.com/stairway/105855/
 * 
 **********************************************/


USE [master];
SET ANSI_NULLS ON;
SET QUOTED_IDENTIFIER ON;
SET NOCOUNT ON;
GO
--------------------------------------------------------------------------------

DECLARE @ErrorMessage NVARCHAR(4000);


-- We first need to create the Assembly containing just
-- the Key info so that we can get the "thumbprint" /
-- "publickeytoken" value from it. That value is used to
-- determine if the Asymmetric Key and Login already exist.
--
-- We only need this Assembly temporarily, so create within
-- a transaction to guarantee cleanup if something fails.

DECLARE	@AssemblyName sysname, -- keep lower-case for servers with case-sensitive / binary collations
		@AsymmetricKeyName sysname, -- keep lower-case for servers with case-sensitive / binary collations
		@LoginName sysname, -- keep lower-case for servers with case-sensitive / binary collations
		@PublicKeyToken VARBINARY(32),
		@SQL NVARCHAR(MAX);

SET @AssemblyName = N'$StairwayToSQLCLR-TEMPORARY-KeyInfo$';

SET @AsymmetricKeyName = N'StairwayToSQLCLR-06_PermissionKey';
SET @LoginName = N'StairwayToSQLCLR-06_PermissionLogin';

BEGIN TRY
	BEGIN TRAN;

	IF (NOT EXISTS(
				SELECT	*
				FROM		[sys].[assemblies] sa
				WHERE	[sa].[name] = @AssemblyName
			)
		)
	BEGIN
		SET @SQL = N'
		CREATE ASSEMBLY [' + @AssemblyName + N']
			AUTHORIZATION [dbo]
-- Insert the result of the following command, found in _TempAssembly.sql, here:
-- FINDSTR /I /C:"FROM 0x" KeyInfo_Create.sql > _TempAssembly.sql
		    FROM 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C0103005D71E85A0000000000000000E00002210B010B00000A00000006000000000000AE28000000200000004000000000001000200000000200000400000000000000040000000000000000800000000200009DCC00000300408500001000001000000000100000100000000000001000000000000000000000005428000057000000004000006003000000000000000000000000000000000000006000000C0000001C2700001C0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000B408000000200000000A000000020000000000000000000000000000200000602E72737263000000600300000040000000040000000C0000000000000000000000000000400000402E72656C6F6300000C000000006000000002000000100000000000000000000000000000400000420000000000000000000000000000000090280000000000004800000002000500E42000003806000009000000000000000000000000000000502000008000000000000000000000000000000000000000000000000000000000000000000000008AF80C908FFD304B826A34DFF6243E28976792BBA558A1E6102B5617645DD39C2CC5342582AE0120673F96062543EED8281F51E4A3A55756DBCC8177AA302B46156676A79B5DEDF126A2A1B3A9975B4F071CA09B41176101EB1FE55C620871D05CC34116EE3DDFBCE4872033487455FE4C3AE222882C4C56C21510187ABDABB32E7E0F00000A731000000A2A1E02281100000A2A42534A4201000100000000000C00000076322E302E35303732370000000005006C000000D4010000237E0000400200008C02000023537472696E677300000000CC0400000800000023555300D4040000100000002347554944000000E40400005401000023426C6F620000000000000002000001471400000900000000FA25330016000001000000120000000200000002000000110000000C000000010000000200000000000A0001000000000006003B0034000A0063004E000600A80096000600BF0096000600DC0096000600FB00960006001401960006002D01960006004801960006006301960006007C0196000600950196000600C501B2013700D901000006000802E80106002802E8010A0069024E0206007E02340000000000010000000000010001000100100016000000050001000100D0200000000096006D000A000100DC2000000000861890000F000100190090001300210090001300290090001300310090001300390090001300410090001300490090001300510090001300590090001300610090001300690090001800790090001E00810090000F00890090000F0091008502CA00110090001300090090000F0020007300C5002E002B00CD002E001300D9002E001B00E7002E002300ED002E000B00CD002E003300FE002E003B00E7002E00530016012E005B0023012E0063002C012E006B0035010480000001000000000000000100000023004602000002000000000000000000000001002B000000000002000000000000000000000001004200000000000000003C4D6F64756C653E004B6579496E666F2E646C6C0055736572446566696E656446756E6374696F6E73006D73636F726C69620053797374656D004F626A6563740053797374656D2E446174610053797374656D2E446174612E53716C54797065730053716C537472696E67004F6E6C794E6565646564546F47656E6572617465437265617465417373656D626C79002E63746F720053797374656D2E5265666C656374696F6E00417373656D626C795469746C6541747472696275746500417373656D626C794465736372697074696F6E41747472696275746500417373656D626C79436F6E66696775726174696F6E41747472696275746500417373656D626C79436F6D70616E7941747472696275746500417373656D626C7950726F6475637441747472696275746500417373656D626C79436F7079726967687441747472696275746500417373656D626C7954726164656D61726B41747472696275746500417373656D626C7943756C7475726541747472696275746500417373656D626C7956657273696F6E41747472696275746500417373656D626C7946696C6556657273696F6E4174747269627574650053797374656D2E446961676E6F73746963730044656275676761626C6541747472696275746500446562756767696E674D6F6465730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650052756E74696D65436F6D7061746962696C697479417474726962757465004B6579496E666F004D6963726F736F66742E53716C5365727665722E5365727665720053716C46756E6374696F6E41747472696275746500537472696E6700456D707479000000032000000000009363871C6E3B1147B9928412EA46066A0008B77A5C561934E089040000110903200001042001010E052001011139042001010880A00024000004800000940000000602000000240000525341310004000001000100A5E788E7262478652ECACC3EC0CF025DC9A480062FA236E63ED5D37C87A28E50F6B955502EF4494AA27128E1D23B5044165CC23CD89FDFC350DCD3343DF1795F0E8135184F398797D4019CE5C84E54E9595BB9433313DD18F8C84B64BF92565F9533D8D7C6DA42B3F04B17CCBA7E1356DCEF9ECA11DB69118BF120310F337FEB040100000002060E0B010006444241434C5200000D0100084B657920496E666F00000501000000001001000B436F6C6C696E67776F6F64000017010012436F7079726967687420C2A920203230313800000C010007312E302E302E3000000801000200000000000801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F777301000000005D71E85A00000000020000001C010000382700003809000052534453CC1812E1843F9340BEBFF25E2B15476501000000633A5C55736572735C616E647265772E6C61636B656E62795C446F63756D656E74735C50726F6A656374735C4C6962726172795C546F6F6C735C444241434C525C4B6579496E666F5C6F626A5C52656C656173655C4B6579496E666F2E70646200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007C28000000000000000000009E280000002000000000000000000000000000000000000000000000902800000000000000000000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF2500200010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100100000001800008000000000000000000000000000000100010000003000008000000000000000000000000000000100000000004800000058400000040300000000000000000000040334000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000001000000000000000100000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B00464020000010053007400720069006E006700460069006C00650049006E0066006F0000004002000001003000300030003000300034006200300000002C000900010043006F006D006D0065006E007400730000004B0065007900200049006E0066006F000000000038000C00010043006F006D00700061006E0079004E0061006D0065000000000043006F006C006C0069006E00670077006F006F0064000000380007000100460069006C0065004400650073006300720069007000740069006F006E000000000044004200410043004C00520000000000300008000100460069006C006500560065007200730069006F006E000000000031002E0030002E0030002E003000000038000C00010049006E007400650072006E0061006C004E0061006D00650000004B006500790049006E0066006F002E0064006C006C0000004800120001004C006500670061006C0043006F007000790072006900670068007400000043006F0070007900720069006700680074002000A900200020003200300031003800000040000C0001004F0072006900670069006E0061006C00460069006C0065006E0061006D00650000004B006500790049006E0066006F002E0064006C006C000000300007000100500072006F0064007500630074004E0061006D0065000000000044004200410043004C00520000000000340008000100500072006F006400750063007400560065007200730069006F006E00000031002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000031002E0030002E0030002E00300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000C000000B03800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000;
';
		EXEC (@SQL);
	END;


	SET @PublicKeyToken = CONVERT(VARBINARY(32), ASSEMBLYPROPERTY(@AssemblyName, 'PublicKey'));

	IF (NOT EXISTS(
				SELECT	*
				FROM		[sys].[asymmetric_keys] sak
				WHERE	sak.[thumbprint] = @PublicKeyToken
			)
		)
	BEGIN
		SET @SQL = N'
		CREATE ASYMMETRIC KEY [' + @AsymmetricKeyName + N']
			AUTHORIZATION [dbo]
			FROM ASSEMBLY [' + @AssemblyName + N'];';
		EXEC (@SQL);
	END;

	SET @SQL = N'DROP ASSEMBLY [' + @AssemblyName + N'];';
	EXEC (@SQL);

	COMMIT TRAN;
END TRY
BEGIN CATCH
	IF (@@TRANCOUNT > 0)
	BEGIN
		ROLLBACK TRAN;
	END;

	SET @ErrorMessage = ERROR_MESSAGE();
	RAISERROR(@ErrorMessage, 16, 1);
	RETURN; -- exit the script
END CATCH;


-- If the Asymmetric Key exists but the Login does not exist, we need to:
-- 1) Create the Login
-- 2) Grant the appropriate permission
IF (EXISTS(
			SELECT	*
			FROM		[sys].[asymmetric_keys] sak
			WHERE	sak.[thumbprint] = @PublicKeyToken
		)
	) AND
	(NOT EXISTS(
			SELECT		*
			FROM			[sys].[server_principals] sp
			INNER JOIN	[sys].[asymmetric_keys] sak
					ON	sak.[sid] = sp.[sid]
			WHERE	sak.[thumbprint] = @PublicKeyToken
		)
	)
BEGIN
	BEGIN TRY
		BEGIN TRAN;

		SET @SQL = N'
		CREATE LOGIN [' + @LoginName + N']
			FROM ASYMMETRIC KEY [' + @AsymmetricKeyName + N'];';
		EXEC (@SQL);

		SET @SQL = N'
		GRANT EXTERNAL ACCESS ASSEMBLY TO [' + @LoginName + N'];
		-- OR, comment out the GRANT statement above, and uncomment the following:
		-- GRANT UNSAFE ASSEMBLY TO [' + @LoginName + N'];
		';
		EXEC (@SQL);

		COMMIT TRAN;
	END TRY
	BEGIN CATCH
		IF (@@TRANCOUNT > 0)
		BEGIN
			ROLLBACK TRAN;
		END;

		SET @ErrorMessage = ERROR_MESSAGE();
		RAISERROR(@ErrorMessage, 16, 1);
		RETURN; -- exit the script
	END CATCH;
END;
--------------------------------------------------------------------------------


